name: Build & Push Image

on:
  workflow_call:
  # push:
  #   branches:
  #     - dev

jobs:
  build-image-weather-api:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v1
      - uses: azure/docker-login@v1
        with:
          login-server: ibmdevopsdemo.azurecr.io
          username: ${{secrets.DEV_ACR_SP_ID}}
          password: ${{secrets.DEV_ACR_SP_PASSWORD}}
      - name: Build and push to ACR
        id: build-image
        working-directory: ./SampleApp/SampleApp.Api
        env:
          COMPOSE_DOCKER_CLI_BUILD: 1
          DOCKER_BUILDKIT: 1
          IMAGE: ibmdevopsdemo.azurecr.io/weather-api:dev.v${{github.run_number}}
          IMAGE_LATEST: ibmdevopsdemo.azurecr.io/weather-api:latest
        run: |
          docker build \
            --tag ${IMAGE} \
            --tag ${IMAGE_LATEST} \
            .
            docker push ${IMAGE}
            docker push ${IMAGE_LATEST}